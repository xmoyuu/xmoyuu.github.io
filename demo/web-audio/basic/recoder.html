<body>
    <audio src="Hanser.mp3" type="audio/mpeg"></audio>
    <button data-playing="false" role="switch" aria-checked="false">
        <span>Play/Pause</span>
    </button>
</body>

<script>
    leftChannelDataArray = []
    rightChannelDataArray = []

    function onAduioProcess(e) {
        leftChannelData = e.inputBuffer.getChannelData(0)
        rightChannelData = e.inputBuffer.getChannelData(1)
        leftChannelDataArray.push(leftChannelData)
        rightChannelDataArray.push(rightChannelData)
        // console.log(leftChannelData, rightChannelData)
    }

    function mergeArray(array) {
        totalLength = array.length * array[0].length
        resultArray = new Float32Array(totalLength)
        offset = 0
        for (i = 0; i < array.length; i++) {
            resultArray.set(array[i], offset)
            offset += array[i].length
        }
        return resultArray
    }

    function interleaveLeftAndRightChannelArray(left, right) {
        totalLength = left.length + right.length
        resultArray = new Float32Array(totalLength)
        for (i = 0; offset < totalLength; i++) {
            offset = i * 2
            resultArray[offset] = left[i]
            resultArray[offset + 1] = right[i]
        }
        return resultArray
    }

    function encodeWAV(array) {
        arrayBuffer = new ArrayBuffer(44 + array.length * 2)
        dataView = new DataView(arrayBuffer)

        /* RIFF identifier */
        writeString(dataView, 0, 'RIFF')
        /* RIFF chunk length */
        dataView.setUint32(4, 36 + array.length * 2, true)
        /* RIFF type */
        writeString(dataView, 8, 'WAVE')
        /* format chunk identifier */
        writeString(dataView, 12, 'fmt ')
        /* format chunk length */
        dataView.setUint32(16, 16, true)
        /* sample format (raw) */
        dataView.setUint16(20, 1, true)
        /* channel count */
        dataView.setUint16(22, numChannels, true)
        /* sample rate */
        dataView.setUint32(24, sampleRate, true)
        /* byte rate (sample rate * block align) */
        dataView.setUint32(28, sampleRate * 4, true)
        /* block align (channel count * bytes per sample) */
        dataView.setUint16(32, numChannels * 2, true)
        /* bits per sample */
        dataView.setUint16(34, 16, true)
        /* data chunk identifier */
        writeString(dataView, 36, 'data')
        /* data chunk length */
        dataView.setUint32(40, array.length * 2, true)

        floatTo16BitPCM(dataView, 44, array)

        return dataView
    }

    function floatTo16BitPCM(output, offset, input) {
        for (i = 0; i < input.length; i++ , offset += 2) {
            volume = Math.max(-1, Math.min(1, input[i]))
            output.setInt16(offset, volume < 0 ? volume * 0x8000 : volume * 0x7FFF, true)
        }
    }

    function writeString(dataView, offset, string) {
        for (i = 0; i < string.length; i++) {
            dataView.setUint8(offset + i, string.charCodeAt(i))
        }
    }

    function dataView2Blob(dataView) {
        blob = new Blob([dataView], { type: 'audio/wav' })
        return blob
    }
</script>
<script>
    BUFFER_SIZE = 4096
    INPUT_CHANNEL_COUNT = 2
    OUTPUT_CHANNEL_COUNT = 2

    audioContext = new window.AudioContext()

    audioElement = document.querySelector('audio')
    sourceNode = audioContext.createMediaElementSource(audioElement)
    sourceNode.connect(audioContext.destination)

    scriptProcessorNode = audioContext.createScriptProcessor(BUFFER_SIZE, INPUT_CHANNEL_COUNT, OUTPUT_CHANNEL_COUNT)
    sourceNode.connect(scriptProcessorNode)
    scriptProcessorNode.connect(audioContext.destination)

    playButton = document.querySelector('button')
    playButton.addEventListener('click', function () {
        // check if context is in suspended state (autoplay policy)
        if (audioContext.state === 'suspended') {
            audioContext.resume()
        }
        // play or pause track depending on state
        if (this.dataset.playing === 'false') {
            scriptProcessorNode.onaudioprocess = onAduioProcess
            audioElement.play()
            sampleRate = audioContext.sampleRate
            numChannels = 2
            this.dataset.playing = 'true'
        } else if (this.dataset.playing === 'true') {
            audioElement.pause()
            leftArray = mergeArray(leftChannelDataArray)
            rightArray = mergeArray(rightChannelDataArray)
            interleaveArray = interleaveLeftAndRightChannelArray(leftArray, rightArray)
            WAVDataView = encodeWAV(interleaveArray)
            WAVblob = dataView2Blob(WAVDataView)
            console.log(WAVblob)
            saveBlob(WAVblob, '1.wav')
            this.dataset.playing = 'false'
        }
    }, false)

    audioElement.addEventListener('ended', () => {
        playButton.dataset.playing = 'false'
    }, false)

    saveBlob = (function () {
        a = document.createElement('a')
        document.body.appendChild(a)
        a.style = 'display: none'
        return function (blob, fileName) {
            url = window.URL.createObjectURL(blob)
            a.href = url
            a.download = fileName
            a.click()
            window.URL.revokeObjectURL(url)
        }
    }())
</script>