<body>
    <p> F12
        Developer Tool
        Network Monitor
        <a href="https://developer.mozilla.org/docs/Tools/Network_Monitor/Throttling">throttling</a>
        &
        disable cache
        to test
    </p>
</body>

<main id=main>
    <progress value="0" max="1" id="progress"></progress>
    <img id="image" height="30%">
</main>

<script id="script">
    fetch('2019-bilibiliID-11371674-BY-你的心弦有我来过-bilibiliUID-11134708-NC.jpg')
        .then(response => stream(response))
        .then(stream => new Response(stream))
        .then(response => response.blob())
        .then(blob => URL.createObjectURL(blob))
        .then(url => image.src = url)
        .catch(error => console.error(error))

    function stream(response) {
        [progressStream, returnStream] = response.body.tee()
        reader = progressStream.getReader()
        contentLength = response.headers.get('content-length')
        loadedLength = 0
        pump()
        function pump() {
            reader.read()
                .then(({ done, value }) => {
                    if (done) {
                        return
                    }
                    loadedLength += value.length
                    progress.value = loadedLength / contentLength
                    pump()
                })
        }
        return returnStream
    }
</script>

<pre><code id="showHTML"></code></pre>
<pre><code id="showScript"></code></pre>
<script>
    showHTML.innerText = `${main.innerHTML}`
    showScript.innerText = `${script.innerText}`
</script>