<body>
    <main id="main">
        <button id="speak"> speak</button>
        <button id="pause"> pause</button>
        <button id="resume"> resume</button>
        <button id="cancel"> cancel</button>
        <button id="getVoices"> getVoices</button>
        <button id="isPending"> isPending</button>
        <button id="isSpeaking"> isSpeaking</button>
    </main>

    <script id="script">
        textList = [
            {
                text: '法治是现代政府管理社会的最好方式，也是我们走出困境、走向明天的最佳选择。实际上，今天这个会就是在昨天和明天之间选择。我们面前摆着两条路，一是恢复和继续走全能政府即人治的老路，靠一位伟大领袖发号施令，用计划经济甚至专营的办法去解决经济领域层层盘剥的问题，靠学习领导人讲话或思想政治工作和道德教育去解决以权谋私、腐败堕落的问题，用加强纪律去解决思想、理论、文化界的是非问题，如果还是这样，小平同志就是活一百岁也解决不了我们的体制转变。',
                lang: 'zh-CN'
            },
            {
                text: 'My political ideal is democracy. Everyone should be respected as an individual, but no one idolized. It is an irony of fate that I should have been showered with so much uncalled-for and unmerited admiration and esteem. Perhaps this adulation springs from the unfulfilled wish of the multitude to comprehend the few ideas which I, with my weak powers, have advanced.',
                lang: 'en-US'
            }
        ]

        voice = null // speechSynthesis.getVoices()
        volume = 1 // 0 ~ 1
        rate = 1 // 0.1 ~ 10
        pitch = 1 // 0 ~ 2

        utteranceList = new Array()
        textList.forEach(element => {
            utterance = new SpeechSynthesisUtterance()

            utterance.text = element.text
            utterance.lang = element.lang

            utterance.voice = voice
            utterance.volume = volume
            utterance.rate = rate
            utterance.pitch = pitch

            utterance.onstart = function (event) {
                console.log('onstart')
            }

            utterance.onpause = function (event) {
                console.log('onpause')
                alert(`
charIndex: ${event.charIndex ? event.charIndex : 'safari unsupport'} 
char: ${event.charIndex ? event.utterance.text.charAt(event.charIndex) : 'safari unsupport'}
elapsedTime: ${event.elapsedTime}
                `)
            }

            utterance.onresume = function (event) {
                console.log('onresume')
                alert('onresume')
            }

            utterance.onend = function (event) {
                console.log('onend')
                alert('onend')
            }

            utterance.onboundary = function (event) {
                console.log('onboundary')
                // safari event.name only word without sentence
                showOutput.innerText += `
name: ${event.name} 
charIndex: ${event.charIndex}
charLength: ${event.charLength ? event.charLength : 'safari unsupport'}
char: ${event.charLength ? event.utterance.text.slice(event.charIndex, event.charIndex + event.charLength) : 'safari unsupport'}
char-safari-support: ${event.target.text.charAt(event.charIndex)}
elapsedTime: ${event.elapsedTime}    
                `
                // alert(stringifyEvent(event))
            }

            utterance.onerror = function (event) {
                console.log('onerror')
                alert('onerror')
            }

            utteranceList.push(utterance)
        })

        document.getElementById('speak').onclick = function () {
            utteranceList.forEach(element => {
                speechSynthesis.speak(element)
            })
        }

        document.getElementById('pause').onclick = function () {
            speechSynthesis.pause()
        }

        document.getElementById('resume').onclick = function () {
            if (speechSynthesis.paused) {
                speechSynthesis.resume()
            }
        }

        document.getElementById('cancel').onclick = function () {
            speechSynthesis.cancel()
        }

        document.getElementById('getVoices').onclick = function () {
            promise = getVoicesPromise()
            promise.then(
                array => {
                    string = stringifyArrayObject(array)
                    stringToJsonURL(string)
                }
            )
        }

        document.getElementById('isPending').onclick = function () {
            alert(speechSynthesis.pending)
        }

        document.getElementById('isSpeaking').onclick = function () {
            alert(speechSynthesis.speaking)
        }

        function getVoicesPromise() {
            // speechSynthesis.getVoices() may return empty array
            // https://stackoverflow.com/a/52005323
            return new Promise(
                function (resolve, reject) {
                    id = setInterval(() => {
                        if (speechSynthesis.getVoices().length !== 0) {
                            resolve(speechSynthesis.getVoices())
                            clearInterval(id)
                        }
                    }, 10)
                }
            )
        }

        function stringifyEvent(event) {
            // How to stringify event object?
            // https://stackoverflow.com/a/34519193
            o = {}
            for (const key in event) {
                o[key] = event[key]
            }
            return JSON.stringify(o, (key, value) => {
                if (value instanceof Node) return 'Node'
                if (value instanceof Window) return 'Window'
                return value
            }, ' ')
        }

        function stringifyObject(Object) {
            o = {}
            for (const key in Object) {
                o[key] = Object[key]
            }
            return JSON.stringify(o, (key, value) => { return value }, ' ')
        }

        function stringifyArrayObject(array) {
            a = []
            o = {}
            array.forEach(element => {
                for (const key in element) {
                    o[key] = element[key]
                }
                a.push(o)
            })
            return JSON.stringify(a, (key, value) => { return value }, ' ')
        }

        function stringToJsonURL(string) {
            blob = new Blob([string], { type: 'application/json' })
            url = URL.createObjectURL(blob)
            window.open(url, '_blank')

            // a = document.createElement('a')
            // a.target = '_black' // will cause safari blob url change 
            // a.href = url
            // a.click()
        }
    </script>
</body>
<pre><code id="showOutput"></code></pre>
<pre><code id="showHTML"></code></pre>
<pre><code id="showScript"></code></pre>
<script>
    showHTML.innerText = `${main.innerHTML}`
    showScript.innerText = `${script.innerText}`
</script>