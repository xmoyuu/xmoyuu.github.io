<!DOCTYPE html>
<html lang="zh-cmn-Hans">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">

    <title>Speech</title>

    <link rel="icon" type="image/png">
    <link rel="apple-touch-icon">
    <script>
        function emojiAsFavicon(emoji, x, y) {
            canvas = document.createElement('canvas')
            canvas.height = 32
            canvas.width = 32
            context = canvas.getContext('2d')
            context.font = '28px serif'
            context.fillText(emoji, x, y)
            icon.href = canvas.toDataURL()

            // string = `background:url('${canvas.toDataURL()}')no-repeat;font-size:32px;`
            // console.log(`%c  `, string)
        }

        function emojiAsAppleTouchIcon(emoji, x, y) {
            canvas = document.createElement('canvas')
            canvas.height = 180
            canvas.width = 180
            context = canvas.getContext('2d')
            context.font = '160px serif'
            context.fillText(emoji, x, y)
            appleTouchIcon.href = canvas.toDataURL()
        }

        icon = document.querySelector('link[rel=icon]')
        appleTouchIcon = document.querySelector('link[rel=apple-touch-icon]')
        emojiAsFavicon('üí¨', -4, 28)
        emojiAsAppleTouchIcon('üí¨', 10, 150)
    </script>

    <style>
        * {
            font-family: "Microsoft YaHei";
        }

        body {
            background: #ebebeb;
        }

        textarea {
            background: #ffffff;

            box-sizing: border-box;
            border: 1px #ddd solid;
            outline: none;

            padding: 20px;

            width: 100%;
            height: 40%;
            resize: none;

            font-size: 100%;
            overflow-y: auto;
        }

        .container {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 100px;
        }

        .highlight {
            background-color: wheat
        }

        #tri {
            text-align: center;
            margin-bottom: 2px;
        }

        #triangle {
            display: inline-block;
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 10px 5px 0 5px;
            border-color: #FF7799 transparent transparent transparent;
        }

        #output {
            background: #ffffff;
            margin-bottom: 20px;
            padding: 20px;

            box-sizing: border-box;
            border: 1px #ddd solid;
            outline: none;

            width: 100%;
            height: 40%;

            font-size: 100%;
            overflow-y: auto;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background: #212121;
                color: #bebebe;
            }

            .highlight {
                background-color: darkslateblue
            }

            textarea {
                background: #181818;
                color: #bebebe;
                border: 0;
            }

            #output {
                background: #181818;
                color: #bebebe;
                border: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <textarea id="textarea" autocomplete="off"></textarea>
        <div id="tri">
            <div id="triangle"></div>
        </div>
        <div id="output"></div>
        <select id="voiceSelect"></select>
        <button id="speak">·êï)‚Åæ‚Åæ Speakk </button>
        <br>
        <label for="rate">Rate</label>
        <input id="rate" type="range" min=0.1 max=10 value=1 step=0.1>
        <span id="rateValue">1</span>
        <br>
        <label for="pitch">Pitch</label>
        <input id="pitch" type="range" min=0 max=2 value=1 step=0.1>
        <span id="pitchValue">1</span>
        <pre><code id="showOutput"></code></pre>
    </div>
</body>

<script>
    pitch.oninput = function () {
        pitchValue.textContent = pitch.value
    }

    rate.oninput = function () {
        rateValue.textContent = rate.value
    }

    function init() {
        pitchValue.textContent = pitch.value
        rateValue.textContent = rate.value
    }
    onload = init

    voiceList = []

    function populateVoiceList() {
        voiceList = speechSynthesis.getVoices()

        voiceSelect.innerHTML = ''
        selected = false
        language = window.navigator.userLanguage || window.navigator.language
        for (i = 0; i < voiceList.length; i++) {
            option = document.createElement('option')
            option.textContent = `${voiceList[i].name}(${voiceList[i].lang})`
            // safari need toLowerCase
            if (voiceList[i].lang.toLowerCase() === language.toLowerCase()
                && !selected) {
                selected = true
                option.setAttribute('selected', selected)
            }

            option.setAttribute('data-lang', voiceList[i].lang)
            option.setAttribute('data-name', voiceList[i].name)
            voiceSelect.appendChild(option)
        }
    }

    populateVoiceList()
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = populateVoiceList
    }

    textarea.placeholder = 'input...'
    // textarea.addEventListener('input', (event) => {
    //     output.innerText = textarea.value
    // })
</script>

<script>
    control = ''
    clickControl = ''
    utteranceList = []
    sentenceNodeList = []

    // split string but keep delimiter 
    // https://stackoverflow.com/a/36465144
    zh_text2sentence = text => text.match(/[^„ÄÇ]+„ÄÇ?|„ÄÇ/g)
    // split string into sentence
    // https://stackoverflow.com/a/18914855
    en_text2sentence = text => text.replace(/([.?!])\s*(?=[A-Z]|\s)/g, '$1|').split('|')
    // sentence2word = sentenceList => sentenceList.split(' ')

    textarea.addEventListener('input', (event) => {
        speechSynthesis.cancel()
        output.innerHTML = ''

        sentenceList = zh_text2sentence(textarea.value)
        sentenceList = sentenceList.map(sentenceList => en_text2sentence(sentenceList))

        newArray = []
        f = (array) => {
            array.forEach((item) => {
                if (Array.isArray(item)) {
                    f(item)
                } else {
                    newArray.push(item)
                }
            })
        }
        f(sentenceList, newArray)
        sentenceList = newArray

        if (sentenceList) {
            sentenceList.forEach((element, index) => {
                span = document.createElement('span')
                span.innerText = element
                span.dataset.id = `${index}`
                span.classList.add('sentence')
                output.appendChild(span)
            })
            // word = sentenceList.map(sentenceList => sentence2word(sentenceList))
        }

        sentenceNodeList = document.querySelectorAll('.sentence')
        sentenceNodeList.forEach(element => {
            element.onclick = function () {
                control = 'click'
                if (speechSynthesis.speaking) {
                    clickControl = 'pause'
                    speechSynthesis.pause()
                }

                if (speechSynthesis.paused) {
                    speechSynthesis.cancel()
                    clickControl = 'select'
                    clickText = element.innerText

                    utteranceList = []

                    for (let index = element.dataset.id; index < sentenceNodeList.length; index++) {
                        const element = sentenceNodeList[index]
                        utteranceList.push(Utterance(element))
                    }

                    utteranceList.forEach(element => {
                        speechSynthesis.speak(element)
                    })
                } else if (!speechSynthesis.speaking) {
                    clickControl = 'first'
                    utteranceList = []

                    for (let index = element.dataset.id; index < sentenceNodeList.length; index++) {
                        const element = sentenceNodeList[index]
                        utteranceList.push(Utterance(element))
                    }

                    utteranceList.forEach(element => {
                        speechSynthesis.speak(element)
                    })
                }
            }
        })
    })

    speak.onclick = function () {
        control = 'speak'
        if (!speechSynthesis.speaking) {
            utteranceList = []

            for (let index = 0; index < sentenceNodeList.length; index++) {
                const element = sentenceNodeList[index]
                utteranceList.push(Utterance(element))
            }

            utteranceList.forEach(element => {
                speechSynthesis.speak(element)
            })
        } else if (speechSynthesis.paused) {
            speechSynthesis.resume()
        }
    }

    function Utterance(element) {
        utterance = new SpeechSynthesisUtterance(element.innerText)
        utterance.text = element.innerText
        utterance.rate = rate.value
        utterance.pitch = pitch.value
        selectedOption = voiceSelect.selectedOptions[0].getAttribute('data-name')
        for (i = 0; i < voiceList.length; i++) {
            if (voiceList[i].name === selectedOption) {
                utterance.voice = voiceList[i]
                break
            }
        }

        utterance.onstart = function (event) { }

        utterance.onend = function (event) {
            if (document.querySelector('.highlight')) {
                document.querySelector('.highlight').className = 'sentence'
            }
        }

        utterance.onboundary = function (event) {
            if (control == 'speak') {
                speakIndex = sentenceList.indexOf(event.srcElement.text)

                sentenceNodeList.forEach(element => {
                    element.className = 'sentence'
                })
                sentenceNodeList[speakIndex].className = 'highlight'
                sentenceNodeList[speakIndex].scrollIntoView()

                showOutput.innerText = `charIndex: ${event.charIndex} char-safari-support: ${event.target.text.charAt(event.charIndex)}`
            } else if (control == 'click') {
                console.log(clickControl)
                console.log(event.target.text)

                if (clickControl == 'first') {
                    speakIndex = sentenceList.indexOf(event.srcElement.text)

                    sentenceNodeList.forEach(element => {
                        element.className = 'sentence'
                    })
                    sentenceNodeList[speakIndex].className = 'highlight'
                    sentenceNodeList[speakIndex].scrollIntoView()

                    showOutput.innerText = `charIndex: ${event.charIndex} char-safari-support: ${event.target.text.charAt(event.charIndex)}`
                }

                if (clickControl == 'pause') {
                    speakIndex = sentenceList.indexOf(event.srcElement.text)

                    sentenceNodeList.forEach(element => {
                        element.className = 'sentence'
                    })
                    sentenceNodeList[speakIndex].className = 'highlight'
                    sentenceNodeList[speakIndex].scrollIntoView()

                    showOutput.innerText = `charIndex: ${event.charIndex} char-safari-support: ${event.target.text.charAt(event.charIndex)} utteranceList: ${utteranceList.length}`
                }

                if (clickControl == 'select') {
                    if (clickText == event.target.text) {
                        speakIndex = sentenceList.indexOf(event.srcElement.text)

                        sentenceNodeList.forEach(element => {
                            element.className = 'sentence'
                        })
                        sentenceNodeList[speakIndex].className = 'highlight'
                        sentenceNodeList[speakIndex].scrollIntoView()

                        showOutput.innerText = `charIndex: ${event.charIndex} char-safari-support: ${event.target.text.charAt(event.charIndex)} utteranceList: ${utteranceList.length}`

                        if (speechSynthesis.pending) {
                            clickText = sentenceNodeList[speakIndex + 1].innerText
                        }
                    } else {
                        speechSynthesis.cancel()
                    }
                }
            }
        }
        return utterance
    }
</script>

</html>