<body>
    <label for="url-choice">URL:</label>
    <input value="192.168.43.134:5500" list="urls" id="url-choice" name="url-choice" />
    
    <datalist id="urls">
        <option value="192.168.43.134:5500">
        <option value="192.168.43.134:80">
    </datalist>
    
    <label for="scanner-select">Choose Scanner:</label>
    
    <select id="scanner-select">
        <option value="websocket">WebSocket</option>
        <option value="ajax">Ajax</option>
        <option value="eventsource">EventSource</option>
        <option value="image">Image</option>
        <option value="video">Video</option>
    </select>
    
    <button id="ok">OK</button>
</body>

<script>
    /*
        HTML 表单协议攻击：https://www.jochentopf.comhfpa/hfpa.pdf
        论文描述了如何通过 HTML 浏览器使用 HTML 表单发任意数据到任意 TCP 端口进行欺骗。这可以使用那基于 ASCII 的协议来发送指令到服务器例如 SMTPNNTP，POP3，IMAP，IRC...通过发送 HTML 邮件到无戒心的用户或查看特洛伊 HTML 页面，因此攻击者以发送邮件或者发布 Usenet 新闻到祂通常无法访问的服务器（攻击者通常在墙外或者其 IP 地址无权访问发送邮件）。一些特别的案例例如从 POP3 邮箱中删除邮件。
        因此网络浏览器和网络代理的作者应确保不允许使用所周知有潜在脆弱的应用程序端口，包含但不限于21(FTP), 25 (SMTP), 110 (POP3),119 (NNTP), 143(IMAP), and 6667 (IRC).端口应被检查，不直接发请求而是通过网络代理的尤甚。

        在浏览器中快速探测 IP 端口是否开放：https://segmentfault.com/a/1190000005746121

        浏览器请求静态资源的并发数：https://github.com/tvrcgo/paper/issues/4

        定时侧通道（端口扫描）于浏览器：https://defuse.ca/in-browser-port-scanning.htm
    */
</script>

<script>
    log = console.log.bind(console)

    isHTTPS = window.location.protocol === 'https:'

    userAgent = window.navigator.userAgent
    isIE = !!userAgent.indexOf('Trident')
    isFirefox = !!userAgent.indexOf('Firefox')
    isChrome = !!userAgent.indexOf('Chrome')

    function isBroadcastAddress(url) {
        return url.split(':').slice(-2, -1).pop().split('.').pop() === '255'
    }

    function haveItemInObject(item, object) {
        return object.indexOf(item) != -1
    }

    function haveBlockedPort(url) {
        if (isIE) {
            // https://blogs.msdn.microsoft.com/ieinternals/2009/06/17/httphttps-port-blocking-in-wininet/
            blockedPorts = [19, 21, 25, 110, 119, 143, 220, 993]
        }
        else if (isFirefox) {
            /*
                https://github.com/mozilla/gecko-dev/blob/master/netwerk/base/nsIOService.cpp
                https://github.com/mozilla/gecko-dev/blob/master/testing/web-platform/tests/fetch/api/request/request-bad-port.html
            */
            blockedPorts = [1, 7, 9, 11, 13, 15, 17, 19, 20, 21, 22, 23, 25, 37, 42, 43, 53, 77, 79, 87, 95, 101, 102, 103, 104, 109, 110, 111, 113, 115, 117, 119, 123, 135, 139, 143, 179, 389, 427, 465, 512, 513, 514, 515, 526, 530, 531, 532, 540, 548, 556, 563, 587, 601, 636, 993, 995, 2049, 3659, 4045, 6000, 6665, 6666, 6667, 6668, 6669, 6697,]
        }
        else if (isChrome) {
            /*
                https://github.com/chromium/chromium/blob/master/net/base/port_util.cc
                https://github.com/chromium/chromium/blob/master/third_party/blink/web_tests/security/block-test.html
            */
            blockedPorts = [1, 7, 9, 11, 13, 15, 17, 19, 20,
                21, 22, 23, 25, 37, 42, 43, 53, 77, 79, 87, 95, 101, 102,
                103, 104, 109, 110, 111, 113, 115, 117, 119, 123, 135, 139,
                143, 179, 389, 465, 512, 513, 514, 515, 526, 530, 531, 532,
                540, 556, 563, 587, 601, 636, 993, 995, 2049, 3659, 4045,
                6000, 6665, 6666, 6667, 6668, 6669,
                // Port numbers that we consider to be invalid due to being out of range.
                Math.pow(2, 16) - 1, Math.pow(2, 16), Math.pow(2, 32) - 1, Math.pow(2, 32),
            ]
        }
        port = parseInt(url.split(':').pop())
        return haveItemInObject(port, blockedPorts)
    }

    function webSocketScanner(url) {
        startTime = new Date().getTime()
        if (!haveItemInObject('://', url)) {
            url = 'wss://' + url
        }
        webSocket = new WebSocket(url)
        webSocket.onopen = webSocket.onmessage = webSocket.onclose =
            webSocket.onerror = function () {
                endTime = new Date().getTime()
                totalTime = endTime - startTime
                if (totalTime < 1500) {
                    console.log('Online')
                } else {
                    console.log('OutTime')
                }
            }
    }
    // websocket('192.168.43.135:5500')

    function ajaxScanner(url) {
        startTime = new Date().getTime()
        if (!haveItemInObject('://', url)) {
            url = 'http://' + url
        }
        xhr = new XMLHttpRequest('Microsoft.XMLHTTP')
        xhr.open('HEAD', url, true)
        xhr.send()
        xhr.onreadystatechange = function () {
            xhr.readyState > 1
            endTime = new Date().getTime()
            totalTime = endTime - startTime
            if (totalTime < 1500) {
                console.log('Online')
            } else {
                console.log('OutTime')
            }
        }
    }
    // ajax('http://192.168.43.134:5500')

    function eventSourceScanner(url) {
        startTime = new Date().getTime()
        if (!haveItemInObject('://', url)) {
            url = 'http://' + url
        }
        eventSource = new EventSource(url)
        eventSource.onload = eventSource.onmessage =
            eventSource.onerror = function () {
                endTime = new Date().getTime()
                totalTime = endTime - startTime
                if (totalTime < 1500) {
                    console.log('Online')
                } else {
                    console.log('OutTime')
                }
            }
    }
    // eventsource('http://192.168.43.134:5500')
    function imageScanner(url) {
        startTime = new Date().getTime()
        if (!haveItemInObject('://', url)) {
            url = 'http://' + url
        }
        img = document.createElement('img')

        img.onload = img.onerror = function () {
            endTime = new Date().getTime()
            totalTime = endTime - startTime
            if (totalTime < 1500) {
                console.log('Online')
            } else {
                console.log('OutTime')
            }
        }
        img.src = url

    }
    // image('http://192.168.43.134:5500')

    function videoScanner(url) {
        startTime = new Date().getTime()
        if (!haveItemInObject('://', url)) {
            url = 'http://' + url
        }
        video = document.createElement('video')
        video.src = url
        video.onprogreventSources = video.onsuspend = video.onerror = function () {
            endTime = new Date().getTime()
            totalTime = endTime - startTime
            if (totalTime < 1500) {
                console.log('Online')
            } else {
                console.log('OutTime')
            }
        }
    }
    // video('http://192.168.43.134:5500')

    function isSupportWebSocket() {
        return !!window.WebSocket
    }

    function isSupportAjax() {
        return !!window.XMLHttpRequest
    }

    function isSupportEventSource() {
        return !!window.EventSource
    }

    function isSupportImage() {
        return document.createElement('img').src !== undefined
    }

    function isSupportVideo() {
        return document.createElement('video').src !== undefined
    }
</script>

<script>
    scanner = document.getElementById('scanner-select').addEventListener('change', checkSupport)
    function checkSupport() {
        scanner = document.getElementById('scanner-select').value
        switch (scanner) {
            case 'websocket': if (!isSupportWebSocket()) alert('unavailable')
                break
            case 'ajax': if (!isSupportAjax()) alert('unavailable')
                break
            case 'eventsource': if (!isSupportEventSource()) alert('unavailable')
                break
            case 'image': if (!isSupportImage()) alert('unavailable')
                break
            case 'video': if (!isSupportVideo()) alert('unavailable')
                break
        }
    }

    button = document.getElementById('ok').addEventListener('click', ok)
    function ok() {
        url = document.getElementById('url-choice').value
        scanner = document.getElementById('scanner-select').value
        switch (scanner) {
            case 'websocket': webSocketScanner(url)
                break
            case 'ajax': ajaxScanner(url)
                break
            case 'eventsource': eventSourceScanner(url)
                break
            case 'image': imageScanner(url)
                break
            case 'video': videoScanner(url)
                break
        }
    }


</script>